blueprint:
  name: Home Generative Agent Scene Analyzer (Clean)
  author: goruck
  description: >
    Periodically prompt the Home Generative Agent to analyze a camera scene.
    If the model does not say "no", optionally send a persistent notification and/or mobile push.
  domain: automation
  source_url: https://github.com/goruck/home-generative-agent

  input:
    time_pattern:
      name: Time Pattern
      description: cron-like time pattern (e.g., /30 for every 30 mins)
      selector:
        text:
          multiline: false
    message:
      name: Prompt
      description: What the agent should evaluate in the image.
      default: Check the front porch camera for one or more boxes.
      selector:
        text:
          multiline: false
    agent_id:
      name: Agent ID
      description: ID of the assistant agent to query.
      default: conversation.home_generative_agent
      selector:
        text:
          multiline: false
    conversation_id:
      name: Conversation ID
      description: Identifier for the chat session.
      default: hga_scene_analysis
      selector:
        text:
          multiline: false
    mobile_device:
      name: Mobile Device (Optional)
      description: Companion app device to notify.
      default: ""
      selector:
        device:
          integration: mobile_app
    send_persistent:
      name: Send persistent notification?
      default: true
      selector:
        boolean: {}

variables:
  v_mobile: !input mobile_device
  v_persist: !input send_persistent

trigger:
  - platform: time_pattern
    minutes: !input time_pattern

condition: []

action:
  - service: conversation.process
    data:
      agent_id: !input agent_id
      text: !input message
      conversation_id: !input conversation_id
    response_variable: hga_scene_analysis_output

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ 'no' not in (hga_scene_analysis_output['response']['speech']['plain']['speech'] | lower) }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ v_persist }}"
                sequence:
                  - service: persistent_notification.create
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ v_mobile != '' }}"
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                      target:
                        - "{{ v_mobile }}"

mode: single
                        {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}
            default: []

          # Mobile push (optional)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ v_mobile != '' }}"
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: >
                        {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}
                      target:
                        - "{{ v_mobile }}"
            default: []

mode: single
                  title: HGA Scene Analysis
                  message: >
                    {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}

          # Optional mobile push (only if a device is selected)
          - if:
              - condition: template
                value_template: "{{ v_mobile != '' }}"
            then:
              - service: notify.notify
                data:
                  title: HGA Scene Analysis
                  message: >
                    {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}
                  target:
                    - "{{ v_mobile }}"

mode: single
          # Optional persistent notification
          - if:
              - condition: template
                value_template: "{{ v_persist }}"
            then:
              - service: notify.persistent_notification
                data:
                  title: HGA Scene Analysis
                  message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"

          # Primary OR targeted (dedup)
          - choose:
              # If mobile selected AND primary is notify.notify -> send ONLY targeted
              - conditions:
                  - condition: template
                    value_template: >
                      {{ v_mobile != '' and (v_notify | lower) == 'notify.notify' }}
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                      target:
                        - "{{ v_mobile }}"
            default:
              - service: "{{ v_notify }}"
                data:
                  title: HGA Scene Analysis
                  message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"

          # Extra targeted ONLY when primary is neither notify.notify nor mobile_app
          - if:
              - condition: template
                value_template: >
                  {{ v_mobile != '' and (v_notify | lower) != 'notify.notify' and ((v_notify | lower)[:19] != 'notify.mobile_app_') }}
            then:
              - service: notify.notify
                data:
                  title: HGA Scene Analysis
                  message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                  target:
                    - "{{ v_mobile }}"

mode: single
        sequence:
          # Optional persistent notification
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ v_persist }}"
                sequence:
                  - action: notify.persistent_notification
                    data:
                      title: HGA Scene Analysis
                      message: >-
                        {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}
            default: []

          # Primary OR targeted mobile (deduped logic)
          - choose:
              # If mobile selected AND primary is notify.notify -> send ONLY targeted mobile
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ v_mobile != '' and (v_notify | lower) == 'notify.notify' }}
                sequence:
                  - action: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: >-
                        {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}
                      target:
                        - "{{ v_mobile }}"
            default:
              # Otherwise send the primary service
              - action: >-
                  {{ v_notify }}
                data:
                  title: HGA Scene Analysis
                  message: >-
                    {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}

          # Extra targeted mobile ONLY when primary is neither notify.notify nor a mobile_app service
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ v_mobile != '' and (v_notify | lower) != 'notify.notify' and ((v_notify | lower)[:19] != 'notify.mobile_app_') }}
                sequence:
                  - action: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: >-
                        {{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}
                      target:
                        - "{{ v_mobile }}"
            default: []

mode: single
          # Optional persistent notification
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ v_persist }}"
                sequence:
                  - service: notify.persistent_notification
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
            default: []

          # Primary OR targeted mobile (deduped)
          - choose:
              # If mobile selected AND primary is notify.notify -> send ONLY targeted mobile
              - conditions:
                  - condition: template
                    value_template: "{{ v_mobile != '' and (v_notify | lower) == 'notify.notify' }}"
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                      target:
                        - "{{ v_mobile }}"
            default:
              # Otherwise send the primary service
              - service: "{{ v_notify }}"
                data:
                  title: HGA Scene Analysis
                  message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"

          # Extra targeted mobile ONLY when primary is neither notify.notify nor a mobile_app service
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ v_mobile != '' and (v_notify | lower) != 'notify.notify' and ((v_notify | lower)[:19] != 'notify.mobile_app_') }}
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                      target:
                        - "{{ v_mobile }}"
            default: []

mode: single
              {{ 'no' not in (hga_scene_analysis_output['response']['speech']['plain']['speech'] | lower) }}
        sequence:
          # Optional persistent notification
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ v_persist }}"
                sequence:
                  - service: notify.persistent_notification
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
            default: []

          # Primary OR targeted mobile (avoid duplicates)
          - choose:
              # If mobile device selected AND primary is notify.notify -> send ONLY targeted mobile
              - conditions:
                  - condition: template
                    value_template: "{{ v_mobile != '' and (v_notify | lower) == 'notify.notify' }}"
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                      target:
                        - "{{ v_mobile }}"
            default:
              # Otherwise send the primary service
              - service: "{{ v_notify }}"
                data:
                  title: HGA Scene Analysis
                  message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"

          # Extra targeted mobile ONLY when primary is neither notify.notify nor a mobile_app service
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ v_mobile != '' and (v_notify | lower) != 'notify.notify' and ((v_notify | lower)[:19] != 'notify.mobile_app_') }}
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_scene_analysis_output['response']['speech']['plain']['speech'] }}"
                      target:
                        - "{{ v_mobile }}"
            default: []

mode: single
    response_variable: hga_scene_analysis_output

  # Mirror inputs into runtime variables and extract message once
  - variables:
      hga_msg: >-
        {{ hga_scene_analysis_output.get('response', {})
                                    .get('speech', {})
                                    .get('plain', {})
                                    .get('speech', '') | string }}
      _send_persistent: !input send_persistent
      _mobile_notify_service: !input mobile_notify_service
      _mobile_device: !input mobile_device

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ 'no' not in (hga_msg | lower) }}"
        sequence:
          # Optional persistent notification
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ _send_persistent }}"
                sequence:
                  - service: notify.persistent_notification
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_msg }}"
            default: []

          # Primary notify
          - service: !input notify_service
            data:
              title: HGA Scene Analysis
              message: "{{ hga_msg }}"

          # Mobile push — prefer explicit service if provided; else fallback to device target
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (_mobile_notify_service | trim) != '' }}"
                sequence:
                  - service: "{{ _mobile_notify_service }}"
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_msg }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (_mobile_device | string | length) > 0 }}"
                sequence:
                  - service: notify.notify
                    data:
                      title: HGA Scene Analysis
                      message: "{{ hga_msg }}"
                      target:
                        - "{{ _mobile_device }}"
            default: []

mode: single
